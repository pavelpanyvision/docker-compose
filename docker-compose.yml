version: "3"

services:

  nginx:
    image: nginx:stable
    restart: always
    volumes:
      - /storage:/usr/share/nginx/html:ro
    network_mode: host

  nginx-rtmp:
    image: gcr.io/anyvision-training/nginx-rtmp
    restart: always
    network_mode: host

  mongo:
    image: mongo:3.4-jessie
    restart: always
    volumes:
      - db_data:/data/db
    network_mode: host

  api:
    image: gcr.io/anyvision-training/api:release-v1.18
    restart: always
    network_mode: host
    depends_on:
      - mongo
      - nginx
    volumes:
      - /storage/logs:/root/Dash-API/logs
    environment:
      - mongo_host=localhost
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  redis:
    image: redis:4-alpine
    restart: always
    network_mode: host

  backend:
    image: gcr.io/anyvision-training/backend:release-v1.18
    restart: always
    network_mode: host
    depends_on:
      - api
      - redis
    volumes:
      - /home/user/license:/home/user/license:ro
      - /tmp/.X11-unix:/tmp/.X11-unix
      - pipe_data:/root/pipe_data
      - /storage/logs:/var/www/html/logs
      - /storage/frame_store:/var/www/html/frame_store
      - /storage/pipe_store:/var/www/html/pipe_store
    environment:
      - DISPLAY=$DISPLAY
    env_file:
      - backend.env
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4005/dashboards_status || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3

  dashboard:
    image: gcr.io/anyvision-training/dashboard:release-v1.18
    restart: always
    shm_size: 1024M
    network_mode: host
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /home/anyvision:/home/anyvision
      - /var/sftp/uploads:/home/anyvision/uploads
    environment:
      - DISPLAY=$DISPLAY

volumes:
  db_data:
  pipe_data:

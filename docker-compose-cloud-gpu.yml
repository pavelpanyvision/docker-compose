#filename: docker-compose-cloud-gpu.yml
version: '3.3'


volumes:
  redis_db_data:
  api_gateway_keys:


networks:
  prod:


services:


  guacamole:
    image: gcr.io/anyvision-training/guacamole:0.9.14
    restart: always
    networks:
      - prod
    ports:
      - "8080:8080"
    volumes:
      - ./guacamole/user-mapping-cloud.xml:/etc/guacamole/user-mapping.xml
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    environment:
      - GUACD_LOGLEVEL=info
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g



  sftp:
    image: gcr.io/anyvision-training/sftp:alpine
    restart: always
    networks:
      - prod
    volumes:
      - /storage/sftp_data:/home/user
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    command: user:pass:2000:2000:files
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g



  nginx:
    image: gcr.io/anyvision-training/nginx:tls.ai
    restart: always
    networks:
      prod:
        aliases:
          - nginx-localnode.tls.ai
    ports:
      - "1935:1935"
      - "443:443"
      #- "80:80"
    volumes:
      - /storage:/opt/nginx/html:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    environment:
      - limit_rate_speed=0
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g



  x11vnc:
    image: gcr.io/anyvision-training/x11vnc
    restart: always
    networks:
      - prod
    #ports:
      #- "5900:5900"
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      #- /dev/shm:/dev/shm:rw
    environment:
      - VNC_OPTIONS=-nodpms -noxdamage -shared -forever -passwd 123456 -rfbport 5900 -display :0
      #- VNC_OPTIONS=-noshm -nodpms -noxdamage -shared -forever -passwd 123456 -rfbport 5900 -display :0
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    ipc: host
    logging:
      options:
        max-size: 1g



  desktop:
    image: gcr.io/anyvision-training/desktop
    restart: always
    privileged: true   ## FOR ACCESSING DEVICES - NOT HOT-PLUGGABLE
    networks:
      - prod
    volumes:
      - /storage/sftp_data:/sftp:ro
      - /ssd/dashboards:/ssd/dashboards:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    environment:
      - DISPLAY=:0
      - UPDATER_URL=dashboard-updater:8888
      - ENABLE_DASHBOARD_WGET=true
    env_file:
      - env/global.env
    ipc: host
    logging:
      options:
        max-size: 1g



  cron:
    image: gcr.io/anyvision-training/supercronic:alpine
    restart: always
    networks:
      prod:
        aliases:
          - cron-localnode.tls.ai
    volumes:
      - /storage:/var/www/html
      - ./crontab/site_crontab:/etc/crontabs/crontab
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    environment:
      - TO_DATE_TRACK_DELETE=30
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g



  rabbitmq:
    image: gcr.io/anyvision-training/rabbitmq:latest
    restart: always
    networks:
      prod:
        aliases:
          - rabbitmq.tls.ai
    # these ports should be opened only in development mode
    ports:
      - "5671:5671"
      - "5672:5672"
      - "15672:15672"
      - "15671:15671"
    volumes:
      - /storage/rabbitmq:/var/lib/rabbitmq
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g



  mongodb:
    image: gcr.io/anyvision-training/mongo:3.6-jessie
    restart: always
    networks:
      prod:
        aliases:
          - mongodb.tls.ai
    #ports:
      #- "27017:27017"
    volumes:
      - /ssd/mongo_db_data:/data/db
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g



  redis:
    image: gcr.io/anyvision-training/redis:latest
    restart: always
    networks:
      prod:
        aliases:
          - redis.tls.ai
    sysctls:
      - net.core.somaxconn=511
    volumes:
      - redis_db_data:/data:rw
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    logging:
      options:
        max-size: 1g



  broadcaster:
    image: gcr.io/anyvision-training/broadcaster:development
    restart: always
    #network_mode: "host"       ## REQUIRED FOR MULTICAST BROADCASTING
    hostname: broadcaster
    #command: --disable-services --no-exitkills --debug sleep infinity       ### development mode  - disable chaperone init
    networks:
      prod:
        aliases:
          - broadcaster.tls.ai
    volumes:
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    depends_on:
      - api
    environment:
      - NODE_DEBUG_OPTION=--inspect=0.0.0.0:38391
      - api_service_ip=api.tls.ai
      - BCAST_SOCKETIO_API_URL=https://api.tls.ai:5443
      - RUN_AS_USER=user
      #- ENABLE_DOCKERIZE=false
      - ENABLE_CHOWN=true
    env_file:
      - env/global.env
      - env/broadcaster.env
    logging:
      options:
        max-size: 1g


  master-sync-service:
    image: gcr.io/anyvision-training/master-sync-service:development
    restart: always
    #network_mode: "host"       ## REQUIRED FOR MULTICAST BROADCASTING
    hostname: master-sync-service
    #command: --disable-services --no-exitkills --debug sleep infinity       ### development mode  - disable chaperone init
    networks:
      prod:
        aliases:
          - master-sync-service.tls.ai
    volumes:
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    depends_on:
      - api
    environment:
      - NODE_DEBUG_OPTION=--inspect=0.0.0.0:38391
      # this FQDN should be updated accrodingly to rabbitmq-master
      - rabbitmq_server_ip=rabbitmq-master.tls.ai
      - rabbitmq_server_port=5672
      #- ENABLE_DOCKERIZE=false
      - ENABLE_CHOWN=true
    env_file:
      - env/global.env
      - env/master-sync-service.env
    logging:
      options:
        max-size: 1g



  apigateway:
    image: gcr.io/anyvision-training/api-gateway:development
    restart: always
    #command: --disable-services --no-exitkills --debug sleep infinity       ### development mode  - disable chaperone init
    networks:
      prod:
        aliases:
          - apigateway.tls.ai
          - apigateway-localnode.tls.ai
    ports:
      - "9443:9443"
      - "38391:38391"
    volumes:
      - /storage:/var/www/html
      - api_gateway_keys:/home/user/api-gateway/config/keys
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
      #- /home/anyvision/Projects/API-gateway:/home/user/api-gateway         ### mount your local project directory to the container
    depends_on:
      - redis
    environment:
      - NODE_DEBUG_OPTION=--inspect=0.0.0.0:38391
      - GATEWAY_HOST=apigateway.tls.ai
      - API_HOST=api.tls.ai
      - DASH_API_URL=https://api.tls.ai:5443
      - GATEWAY_SECURE_URL=https://apigateway.tls.ai:9443
      - GATEWAY_URL=http://apigateway.tls.ai:8080
      - REDIS_HOST=redis.tls.ai
      - RUN_AS_USER=user
      - ENABLE_CHOWN=true
    env_file:
      - env/api-gateway.env
      - env/global.env
    logging:
      options:
        max-size: 1g



  api:
    image: gcr.io/anyvision-training/api:development
    restart: always
    #command: --disable-services --no-exitkills --debug sleep infinity
    networks:
      prod:
        aliases:
          - api.tls.ai
          - api-localnode.tls.ai
    ports:
      - "5443:5443"
      - "38389:38389"
      - "3000:3000"
    volumes:
      - /storage:/var/www/html
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
      #- /home/anyvision/Projects/Dash-API:/home/user/Dash-API               ### mount your local project directory to the container
    environment:
      - NODE_DEBUG_OPTION=--inspect=0.0.0.0:38389
      - API_IP=api.tls.ai
      - MONGO_DB_IP=mongodb.tls.ai
      - CA_HOST=apigateway.tls.ai
      - MASS_IMPORT_IP=reid-localnode.tls.ai          ### use this configuration to configure localhost reid service
      - RUN_AS_USER=user
      - ENABLE_CHOWN=true
    env_file:
      - env/global.env
      - env/api.env
    logging:
      options:
        max-size: 1g



  certificator:
    image: gcr.io/anyvision-training/certificator:latest
    restart: on-failure
    #command: --disable-services --no-exitkills --debug sleep infinity
    volumes:
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    environment:
      - ENABLE_COPY_CERT=true
    logging:
      options:
        max-size: 1g



  backend:
    image: gcr.io/anyvision-training/backend:development
    restart: always
    #command: --disable-services --no-exitkills --debug sleep infinity       ### development mode  - disable chaperone init
    privileged: true    ## FOR ACCESSING DEVICES - NOT HOT-PLUGGABLE
    networks:
      prod:
        aliases:
          - proc-localnode.tls.ai
          - reid-localnode.tls.ai
          - coll-localnode.tls.ai
          - arch-localnode.tls.ai
    extra_hosts:
    #The IP here should point to nginx of the master API
      - "nginx-master-localnode.tls.ai:1.1.1.1"
    ports:
      - "4005:4005"
      - "9067:9067"
      - "9068:9068"
      - "9069:9069"
      - "9022:9022" #ssh
      - "5000-5250:5000-5250/udp"                                            ### for remote VMS rtsp connections
    volumes:
      - /home/user/license:/home/user/license:ro
      - /ssd/backend_data:/root/pipe_data
      - /ssd/track_archive_service_data:/root/track_archive_service_data
      - /storage:/var/www/html
      #- /dev:/dev:rw       ## FOR ACCESSING DEVICES - HOT-PLUGGABLE
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
      #- /root/backend_trunk:/root/backend_trunk                             ### mount your local project directory to the container
    environment:
      - ENABLE_OPENSSH_SERVICE=true
      - BACKEND_OPENSSH_PORT=9022
      - DISPLAY=:0
      - external_ip=proc-localnode.tls.ai
      - storage_ip=nginx-localnode.tls.ai
      - frame_store_storage_ip=nginx-localnode.tls.ai
      - redis_host=127.0.0.1
      - api_service_ip=api.tls.ai
      - mongodb_host=mongodb.tls.ai
      - reid_service_ip=reid-localnode.tls.ai
      - collate_service_ip=coll-localnode.tls.ai
      - track_archive_service_ip=arch-localnode.tls.ai
    env_file:
      - env/backend.env
      - env/global.env
    logging:
      options:
        max-size: 1g
    ipc: host



  dashboard:
    image: gcr.io/anyvision-training/dashboard:development
    restart: always
    #command: --disable-services --no-exitkills --debug sleep infinity       ### development mode - disable chaperone init
    privileged: true   ## FOR ACCESSING DEVICES - NOT HOT-PLUGGABLE
    networks:
      - prod
    shm_size: 1024M
    volumes:
      - /storage/sftp_data:/sftp:rw
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /media:/home/user/media:ro
      - /storage/share:/home/user/share:rw
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
      - /storage/share/anyvision-exports:/root/anyvision-exports:rw
      #- /home/anyvision:/mnt                                                ### mount your home directory to the container
      #- /home/anyvision/Projects/anyvision-dashboard:/home/user/dashboard   ### mount your local project directory to the container
    environment:
      - DISPLAY=:0
      - ssl=true
      - GATEWAY_HOST=apigateway.tls.ai
      - RUN_AS_USER=root
      - ENABLE_CHOWN=true
    env_file:
      - env/global.env
      - env/api-gateway.env
      - env/dashboard.env
    logging:
      options:
        max-size: 1g
    ipc: host



  dante-proxy:
    image: gcr.io/anyvision-training/dante-proxy
    restart: always
    networks:
      - prod
    ports:
      - "1080:1080"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    logging:
      options:
        max-size: 1g



  docker-hoster:
    image: gcr.io/anyvision-training/docker-hoster
    restart: always
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
      - /etc/hosts:/tmp/hosts
    logging:
      options:
        max-size: 1g



  # xorg:
  #   image: gcr.io/anyvision-training/xorg
  #   restart: always
  #   privileged: true
  #   networks:
  #     - prod
  #   volumes:
  #     - /tmp/.X11-unix:/tmp/.X11-unix:rw
  #     - /etc/localtime:/etc/localtime:ro
  #     #- /usr/lib/nvidia-390/xorg:/usr/lib/nvidia/xorg:ro
  #     - /usr/lib/nvidia-396/xorg:/usr/lib/nvidia/xorg:ro
  #   environment:
  #     - DISPLAY=:0
  #     #- VT=vt8
  #     #- ENABLE_CHVT=true
  #     #- ORIGINAL_VT=7
  #     - NVIDIA_DRIVER_CAPABILITIES=all
  #     - NVIDIA_VISIBLE_DEVICES=all
  #   env_file:
  #     - env/global.env
  #   logging:
  #     options:
  #       max-size: 1g
  #   ipc: host



  dashboard-updater:
    image: gcr.io/anyvision-training/dashboard-updater:latest
    restart: always
    networks:
      - prod
    ports:
      - "8888:8888"
    volumes:
      - /ssd/dashboards:/opt/nginx/html:rw
      - /etc/localtime:/etc/localtime:ro
      #- /etc/timezone:/etc/timezone:ro
    environment:
      - limit_rate_speed=0
      - DASHBOARD_VERSION=1.20.0
      - ENABLE_FETCHER=true
      - ENABLE_NGINX=true
    env_file:
      - env/global.env
    logging:
      options:
        max-size: 1g
